{% extends "base.html" %}

{% block content %}
<style>
    /* Header style: gray text, not bold */
    table.dataTable thead th {
        background-color: #f9fafb;
        /* Tailwind's gray-50 */
        color: #6b7280 !important;
        /* Tailwind's gray-500 */
        font-weight: 400 !important;
        /* Normal, not bold */
        font-size: 0.875rem !important;
        /* text-sm */
        padding: 6px 8px !important;
        white-space: nowrap;
    }

    /* Table body cell style */
    table.dataTable tbody td {
        font-size: 0.875rem !important;
        /* text-sm */
        padding: 4px 8px !important;
        white-space: nowrap;
        vertical-align: middle;
    }

    /* Full width and auto layout */
    table.dataTable {
        width: 100% !important;
        table-layout: auto;
    }

    /* Align details icon center if responsive collapse is used */
    table.dataTable.dtr-inline.collapsed>tbody>tr>td:first-child:before {
        top: 50%;
        transform: translateY(-50%);
    }

    .currency {
        font-family: 'Courier New', monospace;
    }
</style>

<section class="w-full text-gray-800 text">
    <div class="flex flex-col md:flex-row gap-4 md:gap-8 space-y-6">
        <div class="w-full md:w-1/3 space-y-6">
            <div class="space-y-6 px-6 md:p-0">
                <div class="mb-6 border-b border-gray-300">
                    <nav class="flex pb-4" aria-label="Breadcrumb">
                        <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                            <li class="inline-flex items-center">
                                <a href="{{ url_for('dashboard') }}"
                                    class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600
                                    {% if request.path == '/dashboard' %}
                    text-gray-400
                    {% else %}
                    self-center
                    {% endif %}">
                                    Home
                                </a>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                            stroke-width="2" d="m1 9 4-4-4-4" />
                                    </svg>
                                    <a href="{{ url_for('income') }}" class="ms-1 text-sm font-medium md:ms-2 hover:text-blue-600
            {% if request.path == '/income' %}
                    text-gray-400
                    {% else %}
                    self-center
                    {% endif %}">Income</a>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                            stroke-width="2" d="m1 9 4-4-4-4" />
                                    </svg>
                                    <a href="{{ url_for('expenses') }}" class="ms-1 text-sm font-medium md:ms-2 hover:text-blue-600
            {% if request.path == '/expenses' %}
                    text-gray-400
                    {% else %}
                    self-center
                    {% endif %}">Expenses</a>
                                </div>
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="text-center md:text-left space-y-2">
                    <h2 class="text-xl font-medium text-gray-800 capitalize">{{ tipe }} Form</h2>
                    <p class="text-gray-500 text-sm">Make sure everythingâ€™s filled out correctly</p>
                </div>

                <form method="POST" class="space-y-4">
                    <div class="space-y-2">
                        <div class="mb-1">
                            <label class="block text-sm font-bold text-gray-700">Item</label>
                        </div>
                        <input type="text" name="item" required placeholder="Enter item name or description"
                            class="w-full p-3 text-sm border border-gray-200 rounded bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-300">
                    </div>

                    <div class="space-y-2">
                        <div class="mb-1">
                            <label class="block text-sm font-bold text-gray-700">Amount</label>
                        </div>
                        <input type="text" id="amount_display" required placeholder="Enter numeric amount"
                            class="w-full p-3 text-sm border border-gray-200 rounded bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-300">
                        <input type="hidden" id="amount_real" name="amount">
                    </div>

                    <div class="grid gap-6 grid-cols-2">
                        <div>
                            <div class="mb-1">
                                <label class="block text-sm font-bold text-gray-700">Date</label>
                            </div>
                            <input type="date" name="date" value="{{ today }}" required
                                class="w-full p-3 text-sm border border-gray-200 rounded bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-300">
                        </div>

                        <div>
                            <div class="mb-1">
                                <label class="block text-sm font-bold text-gray-700">Category</label>
                            </div>
                            <select name="category" required
                                class="w-full p-3 text-sm border border-gray-200 rounded bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-300">
                                <option value="" disabled selected>Choose</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <button type="submit"
                        class="mt-2 w-full bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-3 px-6 rounded-md font-medium hover:from-blue-600 hover:to-indigo-600 transition-all duration-300 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Simpan
                    </button>
                </form>

                <div class="mt-10">
                    <h3 class="text-base font-medium text-gray-700 mb-3">
                        {{ month_name }} {{ selected_year }} {{ tipe|capitalize }} Summary by Category
                    </h3>
                    <canvas id="barChart" data-labels='{{ chart_labels | tojson | safe }}'
                        data-data='{{ chart_data | tojson | safe }}' class="w-full h-64">
                    </canvas>
                </div>
            </div>
        </div>
        <div class="w-full md:w-2/3 space-y-6">
            <div class="bg-white rounded-t-3xl md:rounded-lg">
                <div class="space-y-6 p-6">
                    <div class="md:flex items-center justify-between mb-6">
                        <div class="text-center md:text-left space-y-2">
                            <h2 class="text-xl font-medium text-gray-800 capitalize">{{tipe}} Report ({{ month_name }}
                                {{
                                selected_year }})</h2>
                            <p class="text-gray-500 text-sm">View your monthly {{tipe}} report.</p>
                        </div>
                        <div class="mb-4 md:flex md:justify-end space-x-2">
                            <!-- Filter Section -->
                            <form method="get"
                                class="w-full flex flex-col sm:flex-row items-center justify-start sm:justify-end gap-2 sm:gap-3 mt-4 mb-6">
                                <!-- Month Selector -->
                                <div class="w-full sm:w-auto">
                                    <label for="month" class="sr-only">Month</label>
                                    <select id="month" name="month"
                                        class="w-full sm:w-auto px-3 py-2 text-sm border border-gray-300 rounded-md bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        {% for m in range(1, 13) %}
                                        <option value="{{ m }}" {% if m|string==selected_month %}selected{% endif %}>
                                            {{ m | monthname }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Year Selector -->
                                <div class="w-full sm:w-auto">
                                    <label for="year" class="sr-only">Year</label>
                                    <select id="year" name="year"
                                        class="w-full sm:w-auto px-3 py-2 text-sm border border-gray-300 rounded-md bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        {% for y in range(2025, now().year + 1) %}
                                        <option value="{{ y }}" {% if y|string==selected_year %}selected{% endif %}>{{ y
                                            }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Submit Button -->
                                <div class="w-full sm:w-auto">
                                    <button type="submit"
                                        class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        Filter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="overflow-x-auto w-full py-4">
                        <table id="records-table"
                            class="table-auto w-full text-sm whitespace-nowrap divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr class="bg-gray-50">
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        No
                                    </th>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Item</th>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Category</th>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Amount
                                    </th>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Date</th>
                                    <th
                                        class="px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for row in records %}
                                <tr class="odd:bg-white even:bg-gray-50 hover:bg-gray-100 text-sm">
                                    <td class="px-3 py-2 whitespace-nowrap text-gray-900">{{ loop.index }}</td>
                                    <td class="px-3 py-2 capitalize whitespace-nowrap">{{ row[1] }}</td>
                                    <td class="px-3 py-2 capitalize whitespace-nowrap">{{ row[2] }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap currency">{{ row[3]|format_rupiah }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap">{{ row[0]|format_date }}</td>
                                    <td class="px-3 py-2">
                                        <div class="flex items-center space-x-2">
                                            <button class="edit-btn cursor-pointer
                                            hover:text-blue-800 active:text-blue-900
                                            font-medium text-sm
                                            transition-all duration-200 ease-in-out
                                            hover:underline hover:underline-offset-2">Edit
                                            </button>
                                            <!-- Separator -->
                                            <span class="text-gray-300">|</span>
                                            <button class="delete-product cursor-pointer
                                            text-red-600 hover:text-red-800 active:text-red-900
                                            font-medium text-sm
                                            py-1
                                            transition-all duration-200 ease-in-out
                                            hover:underline hover:underline-offset-2">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="px-3 py-2 text-right font-medium text-sm text-gray-700">Total
                                    </th>
                                    <th id="total-amount" class="px-2 py-2 text-sm text-gray-900 currency"></th>
                                    <th colspan="2"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<!--datatables-->
<script>
    $(document).ready(function () {
        $('#records-table').DataTable({
            responsive: {
                details: { type: 'column', target: 'tr' }
            },
            paging: false,           // Disable pagination
            lengthChange: false,     // Hide "Show entries"
            language: {
                search: "Search:",
                info: "Showing _TOTAL_ entries",
                zeroRecords: "No records found"
            },
            columnDefs: [{
                targets: 0,
                searchable: false,
                orderable: false,
                render: (data, type, row, meta) => meta.row + 1,
                className: "px-2 py-1"
            },
            { targets: '_all', className: "px-2 py-1" }
            ],
            dom:
                // Only search bar on top, and info on bottom
                '<"flex flex-col sm:flex-row sm:items-center sm:justify-end gap-4 mb-4"f>' +
                'rt' +
                '<"text-sm text-gray-600 mt-4"i>',
            initComplete: function () {
                $('.dataTables_filter label').addClass('text-sm font-medium text-gray-700');
                $('.dataTables_filter input').addClass('ml-2 px-3 py-2 border border-gray-300 rounded text-sm');
                $('.dataTables_info').addClass('text-sm text-gray-600 mt-2');
            },

            // ðŸ‘‡ Footer callback untuk total amount
            footerCallback: function (row, data, start, end, display) {
                let api = this.api();

                // Ambil kolom Amount (kolom ke-3 atau index 3)
                let parseAmount = val => {
                    if (typeof val === 'string') {
                        val = val.replace(/[^\d]/g, ''); // Hapus semua kecuali digit
                        return parseInt(val) || 0;
                    }
                    return typeof val === 'number' ? val : 0;
                };

                let total = api.column(3, { page: 'current' }).data().reduce(function (a, b) {
                    return parseAmount(a) + parseAmount(b);
                }, 0);

                // Format ke Rupiah
                const formatted = new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(total);

                // Tampilkan ke kolom footer
                $(api.column(3).footer()).html(formatted);
            }
        });
    });
</script>

<!-- bar chart-->
<script>
    const canvas = document.getElementById('barChart');
    const labels = JSON.parse(canvas.dataset.labels || '[]');
    const data = JSON.parse(canvas.dataset.data || '[]');

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total',
                data: data,
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const value = context.raw || 0;
                            return 'Rp ' + value.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return 'Rp ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>

<!--Amount formatter-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const displayInput = document.getElementById("amount_display");
        const realInput = document.getElementById("amount_real");

        // Format angka pakai titik
        function formatWithDot(number) {
            return number.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Hapus semua karakter kecuali angka
        function getRawNumber(str) {
            return str.replace(/[^\d]/g, "");
        }

        displayInput.addEventListener("input", function () {
            const raw = getRawNumber(this.value);
            const formatted = formatWithDot(raw);
            this.value = formatted;
            realInput.value = raw;
        });

        // Hanya izinkan angka saat diketik
        displayInput.addEventListener("keypress", function (e) {
            if (!/\d/.test(e.key)) e.preventDefault();
        });
    });
</script>

{% endblock %}