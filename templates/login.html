<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Catat Keuangan{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/logo-white.png') }}">

    <!-- Tailwind CSS (dihasilkan oleh Tailwind CLI) -->
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet">

    <!-- Font Awesome CDN (versi 6+) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css">

    <!--Sweetalert-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <meta name="theme-color" content="#0d6efd">
    <script>
        // Manifest dengan cache busting agresif
        const timestamp = Date.now();
        const currentOrigin = window.location.origin;

        const manifestData = {
            "name": "Catat Keuangan",
            "short_name": "CatatKeuangan",
            "description": "Aplikasi pencatatan keuangan pribadi",
            "start_url": currentOrigin + "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#0d6efd",
            "icons": [
                {
                    "src": currentOrigin + `/static/icons/logo-black.png?v=${timestamp}`,
                    "type": "image/png",
                    "sizes": "192x192",
                    "purpose": "any"
                },
                {
                    "src": currentOrigin + `/static/icons/logo-background.png?v=${timestamp}`,
                    "type": "image/png",
                    "sizes": "512x512",
                    "purpose": "any"
                }
            ]
        };

        // Create manifest dengan timestamp
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {
            type: 'application/manifest+json'
        });
        const manifestURL = URL.createObjectURL(manifestBlob);

        // Remove existing manifest links
        document.querySelectorAll('link[rel="manifest"]').forEach(link => link.remove());

        // Add new manifest link dengan timestamp
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        link.dataset.timestamp = timestamp;
        document.head.appendChild(link);

        //console.log(`ðŸ“± Manifest updated with timestamp: ${timestamp}`);

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js')
                .then(() => console.log('Service Worker Registered'))
                .catch((error) => console.error('Service Worker failed:', error));
        }
    </script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>

<body class="bg-white flex flex-col p-0 md:p-0 min-h-screen w-full text-gray-800">
    <nav class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50" x-data="{ userMenuOpen: false }">
        <div class="max-w-screen-xl mx-auto px-4 py-1.5">
            <div class="flex items-center justify-between">
                <!-- Left Side - Logo and Navigation Menu -->
                <div class="flex items-center space-x-8">
                    <!-- Logo/Brand -->
                    <div class="flex items-center flex-shrink-0">
                        <img src="{{ url_for('static', filename='icons/logo-black.png') }}" alt="Logo"
                            style="width: 25px; height: 25px;"
                            class="object-contain transition-transform duration-200 hover:scale-110 mr-2">
                        <span
                            class="text-sm font-normal text-gray-900 uppercase tracking-wide hover:text-blue-600 focus:outline-none transition-colors duration-200 cursor-pointer">
                            Catat<span class="font-black">Keuangan</span>
                        </span>
                    </div>
                </div>

                <!-- Right Side -->
                <div class="flex items-center">
                    <div class="flex items-center text-sm text-gray-600">
                        <div class="flex items-center space-x-2 ml-3">
                            <button id="installBtn"
                                class="flex items-center gap-2 w-full px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 text-left cursor-pointer">
                                <i class="fa-solid fa-download w-4 text-center"></i>
                                Install App
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Container: center and responsive -->
    <div class="min-h-screen flex items-center justify-center px-8 md:px-4">
        <div class="w-full max-w-md">

            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="p-3 mb-6 text-sm text-yellow-800 rounded-lg bg-yellow-50" role="alert">
                {% for msg in messages %}
                <span>{{ msg }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Info Teks -->
            <h2 class="text-lg font-semibold text-left text-gray-700 mb-8">
                Login to access the system
            </h2>

            <!-- Form -->
            <form method="post" action="{{ url_for('login') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">


                <!-- Username -->
                <div class="relative z-0 w-full group">
                    <input type="text" name="username" id="floating_username"
                        class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                        placeholder=" " required />
                    <label for="floating_username"
                        class="peer-focus:font-medium absolute text-sm text-gray-500 duration-300 transform -translate-y-6 scale-75 top-2 -z-10 origin-[0] peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-100 peer-focus:scale-75 peer-focus:-translate-y-6">
                        Username
                    </label>
                </div>

                <!-- Password -->
                <div class="relative z-0 w-full group">
                    <input type="password" name="password" id="floating_password"
                        class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                        placeholder=" " required />
                    <label for="floating_password"
                        class="peer-focus:font-medium absolute text-sm text-gray-500 duration-300 transform -translate-y-6 scale-75 top-2 -z-10 origin-[0] peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-100 peer-focus:scale-75 peer-focus:-translate-y-6">
                        Password
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="text-left flex gap-4">
                    <button id="loginBtn" type="submit"
                        class="flex items-center justify-center gap-2 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 cursor-pointer w-26">
                        <span id="btnText">
                            <i class="fa-solid fa-right-to-bracket mr-2"></i> Login
                        </span>
                        <svg id="spinner" class="hidden w-4 h-4 animate-spin text-white" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                    </button>
                    <a href="{{ url_for('dashboard') }}"
                        class="flex items-center justify-center gap-2 text-gray-800 bg-white border border-gray-200 hover:bg-gray-50 hover:text-blue-600 focus:ring-2 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-8 py-2.5 cursor-pointer w-26 transition-colors duration-200 no-underline">
                        <span>Continue</span>
                    </a>
                </div>
            </form>

        </div>
    </div>


    <footer class="backdrop-blur-sm py-2 sm:py-3 mt-auto shadow bg-white text-center text-xs sm:text-sm text-gray-800">
        <div class="container mx-auto">
            <p>&copy; <span id="current-year"></span> catat-keuangan. All rights reserved.</p>
        </div>
    </footer>

    <!--Current Year-->
    <script>
        document.getElementById("current-year").textContent = new Date().getFullYear();
    </script>

    <!--Spinner loading login-->
    <script>
        const form = document.querySelector("form");
        const loginBtn = document.getElementById("loginBtn");
        const btnText = document.getElementById("btnText");
        const spinner = document.getElementById("spinner");

        form.addEventListener("submit", function () {
            loginBtn.disabled = true;
            btnText.classList.add("hidden");
            spinner.classList.remove("hidden");
        });
    </script>

    <!--install webapp-->
    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Tampilkan tombol custom
            const btn = document.getElementById('installBtn');
            btn.style.display = 'inline-block';

            btn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        //console.log('User accepted A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });
    </script>

</body>

</html>